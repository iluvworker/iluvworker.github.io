<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      margin: 0;
      height: 100vh;
      background-color: #fff;
      color: #000;
    }

    aside {
      width: 200px;
      background: #f5f5f5;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      border-right: 2px solid #ccc;
    }

    aside button {
      background: #e0e0e0;
      color: #000;
      border: none;
      padding: 10px;
      border-radius: 6px;
      cursor: pointer;
      text-align: left;
    }

    aside button:hover {
      background: #d0d0d0;
    }

    main {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    th, td {
      border-bottom: 1px solid #ccc;
      padding: 10px;
      text-align: left;
      vertical-align: middle;
    }

    img {
      width: 100px;
      border-radius: 4px;
    }

    button.action-btn {
      background: #0078d7;
      border: none;
      padding: 6px 10px;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
    }

    button.delete-btn {
      background: #d9534f;
    }

    input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
    }

    h3 {
      border-left: 4px solid #0078d7;
      padding-left: 8px;
    }

    small {
      color: #666;
    }
  </style>
</head>
<body>

  <aside>
    <button onclick="showSection('postFormSection')">投稿画面</button>
    <button onclick="showSection('postListSection')">投稿一覧</button>
  </aside>

  <main>
    <!-- 投稿画面 -->
    <section id="postFormSection">
      <h3>新規投稿</h3>
      <form id="postForm">
        <label>販売サイトURL（FANZA / MGS）：</label>
        <input type="url" id="workURL" placeholder="https://www.dmm.co.jp/... または https://www.mgstage.com/..." required />

        <label>サムネURL：</label>
        <input type="url" id="thumbURL" placeholder="https://...jpg / .webp" required />

        <label>動画URL：</label>
        <input type="url" id="videoURL" placeholder="https://...mp4" required />

        <button type="submit">登録</button>
      </form>

      <h3>投稿一覧（最新）</h3>
      <table id="postTable">
        <thead>
          <tr>
            <th>サムネ</th>
            <th>作品URL</th>
            <th>動画</th>
            <th>投稿日</th> 
            <th>操作</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- 投稿一覧 -->
    <section id="postListSection" style="display:none;">
      <h3>投稿一覧</h3>
      <table id="allPostsTable">
        <thead>
          <tr>
            <th>サムネ</th>
            <th>作品URL</th>
            <th>動画</th>
            <th>投稿日</th> 
            <th>操作</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <script>
    // ===== GitHub設定 =====
    const GITHUB_TOKEN = process.env.TOKEN; // ← Secrets から自動取得
    const REPO_OWNER = "iluvworker"; // ← 例: "kyontan"
    const REPO_NAME = "iluvworker.github.io";        // ← 例: "video-manager"
    const FILE_PATH = "posts.json";

    // ===== セクション切替 =====
    function showSection(id) {
      document.querySelectorAll('main section').forEach(sec => sec.style.display = 'none');
      document.getElementById(id).style.display = 'block';
      sessionStorage.setItem('lastSection', id);
    }

    window.addEventListener('load', () => {
      const last = sessionStorage.getItem('lastSection') || 'postFormSection';
      showSection(last);
      loadPosts();
    });

    // ===== 投稿データ読み込み =====
    let posts = [];

    async function loadPosts() {
      try {
        const res = await fetch(`https://${REPO_OWNER}.github.io/${REPO_NAME}/posts.json?_=${Date.now()}`);
        posts = await res.json();
        renderPosts();
      } catch (err) {
        console.error("読み込みエラー:", err);
        posts = [];
      }
    }

    // ===== 投稿一覧の描画 =====
    const postForm = document.getElementById('postForm');
    const postTable = document.querySelector('#postTable tbody');
    const allPostsTable = document.querySelector('#allPostsTable tbody');

    function detectSiteName(url) {
      const u = (url || '').toLowerCase();
      if (u.includes('mgstage.com')) return 'MGS';
      if (u.includes('dmm.co.jp') || u.includes('fanza')) return 'FANZA';
      return '不明';
    }

    function normalizePost(p) {
      if (!p.site) p.site = detectSiteName(p.url || p.fanza);
      if (!p.url && p.fanza) p.url = p.fanza;
      return p;
    }

    function renderPosts() {
      postTable.innerHTML = "";
      allPostsTable.innerHTML = "";
      posts = posts.map(normalizePost);
      [...posts].reverse().forEach((p, i) => {
        const siteName = detectSiteName(p.url);
        const linkHTML = `<a href="${p.url}" target="_blank">${siteName}</a>`;
        const row = `
          <tr>
            <td><img src="${p.thumb}" alt="thumb"></td>
            <td>${linkHTML}</td>
            <td><a href="${p.video}" target="_blank">動画</a></td>
            <td>${p.date || '—'}</td>
            <td>
              <button class="action-btn" onclick="editPost(${i})">編集</button>
              <button class="action-btn delete-btn" onclick="deletePost(${i})">削除</button>
            </td>
          </tr>`;
        postTable.insertAdjacentHTML('beforeend', row);
        allPostsTable.insertAdjacentHTML('beforeend', row);
      });
    }

    // ===== GitHub更新処理 =====
    async function updateGitHubPosts(posts) {
      const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`;
      const res = await fetch(url, { headers: { Authorization: `token ${GITHUB_TOKEN}` } });
      const data = await res.json();
      const content = btoa(unescape(encodeURIComponent(JSON.stringify(posts, null, 2))));

      await fetch(url, {
        method: "PUT",
        headers: {
          Authorization: `token ${GITHUB_TOKEN}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          message: "update posts",
          content: content,
          sha: data.sha,
        }),
      });
    }

    // ===== 新規投稿 =====
    postForm.addEventListener('submit', async e => {
      e.preventDefault();
      const workURL = document.getElementById('workURL').value.trim();
      const thumbURL = document.getElementById('thumbURL').value.trim();
      const videoURL = document.getElementById('videoURL').value.trim();

      const newPost = {
        site: detectSiteName(workURL),
        url: workURL,
        thumb: thumbURL,
        video: videoURL,
        date: new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })
      };

      posts.push(newPost);
      renderPosts();
      postForm.reset();
      await updateGitHubPosts(posts);
      alert("投稿をGitHubに保存しました！");
    });

    // ===== 削除 =====
    async function deletePost(i) {
      posts.splice(i, 1);
      renderPosts();
      await updateGitHubPosts(posts);
      alert("削除しました！");
    }

    function editPost(i) {
      alert(`編集モード（仮）: ${posts[i].url}`);
    }
  </script>
</body>
</html>
