<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      margin: 0;
      height: 100vh;
      background-color: #fff;
      color: #000;
    }
    aside {
      width: 200px;
      background: #f5f5f5;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      border-right: 2px solid #ccc;
    }
    aside button {
      background: #e0e0e0;
      color: #000;
      border: none;
      padding: 10px;
      border-radius: 6px;
      cursor: pointer;
      text-align: left;
    }
    aside button:hover { background: #d0d0d0; }
    main {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border-bottom: 1px solid #ccc;
      padding: 10px;
      text-align: left;
      vertical-align: middle;
    }
    img { width: 100px; border-radius: 4px; }
    button.action-btn {
      background: #0078d7;
      border: none;
      padding: 6px 10px;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
    }
    button.delete-btn { background: #d9534f; }
    input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
    }
    h3 { border-left: 4px solid #0078d7; padding-left: 8px; }
    small { color: #666; }
  </style>
</head>
<body>

  <aside>
    <button onclick="showSection('postFormSection')">投稿画面</button>
    <button onclick="showSection('postListSection')">投稿一覧</button>
  </aside>

  <main>
    <!-- 投稿画面 -->
    <section id="postFormSection">
      <h3>新規投稿</h3>
      <form id="postForm">
        <label>販売サイトURL（FANZA / MGS）：</label>
        <input type="url" id="workURL" placeholder="https://..." required />

        <label>サムネURL：</label>
        <input type="url" id="thumbURL" placeholder="https://..." required />

        <label>動画URL：</label>
        <input type="url" id="videoURL" placeholder="https://..." required />

        <button type="submit">登録</button>
      </form>

      <h3>投稿一覧（最新）</h3>
      <table id="postTable">
        <thead>
          <tr>
            <th>サムネ</th>
            <th>作品URL</th>
            <th>動画</th>
            <th>投稿日</th> 
            <th>操作</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- 投稿一覧 -->
    <section id="postListSection" style="display:none;">
      <h3>投稿一覧</h3>
      <table id="allPostsTable">
        <thead>
          <tr>
            <th>サムネ</th>
            <th>作品URL</th>
            <th>動画</th>
            <th>投稿日</th> 
            <th>操作</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

<script>
const REPO_OWNER = "iluvworker";
const REPO_NAME = "iluvworker.github.io";
const FILE_PATH = "posts.json";

let posts = [];

// ==============================
// セクション切替
// ==============================
function showSection(id) {
  document.querySelectorAll('main section').forEach(sec => sec.style.display = 'none');
  document.getElementById(id).style.display = 'block';
  sessionStorage.setItem('lastSection', id);
}

window.addEventListener('load', () => {
  const last = sessionStorage.getItem('lastSection') || 'postFormSection';
  showSection(last);
  initializePosts();
});

// ==============================
// データ初期化
// ==============================
async function initializePosts() {
  const localData = localStorage.getItem('pendingPosts');
  if (localData) {
    posts = JSON.parse(localData);
    renderPosts();
  }
  await loadFromGitHub();
}

// ==============================
// GitHubから読み込み
// ==============================
async function loadFromGitHub() {
  try {
    const res = await fetch(`https://${REPO_OWNER}.github.io/posts.json?_=${Date.now()}`);
    if (res.ok) {
      const remoteData = await res.json();
      // マージ（重複回避）
      const urls = new Set(posts.map(p => p.url));
      const merged = [...remoteData, ...posts.filter(p => !urls.has(p.url))];
      posts = merged;
      renderPosts();
      localStorage.setItem('pendingPosts', JSON.stringify(posts));
    }
  } catch (err) {
    console.warn("GitHubからの読み込みエラー:", err);
  }
}

// ==============================
// ワークフロー起動
// ==============================
async function triggerWorkflow() {
  try {
    await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/actions/workflows/update-posts.yml/dispatches`, {
      method: "POST",
      headers: { "Accept": "application/vnd.github+json" },
      body: JSON.stringify({ ref: "main" })
    });
    console.log("GitHub Actions triggered");
  } catch (e) {
    console.error("ワークフロー起動失敗:", e);
  }
}

// ==============================
// 投稿追加
// ==============================
document.getElementById('postForm').addEventListener('submit', async e => {
  e.preventDefault();
  const workURL = workURLInput.value.trim();
  const thumbURL = thumbURLInput.value.trim();
  const videoURL = videoURLInput.value.trim();

  const newPost = {
    site: detectSiteName(workURL),
    url: workURL,
    thumb: thumbURL,
    video: videoURL,
    date: new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })
  };

  posts.push(newPost);
  renderPosts();
  localStorage.setItem('pendingPosts', JSON.stringify(posts));
  await triggerWorkflow();

  alert("投稿データを送信しました。反映まで数分お待ちください。");
  e.target.reset();
});

// ==============================
// 削除機能
// ==============================
async function deletePost(i) {
  if (!confirm("本当に削除しますか？")) return;
  posts.splice(i, 1);
  renderPosts();
  localStorage.setItem('pendingPosts', JSON.stringify(posts));
  await triggerWorkflow();
  alert("削除しました（反映まで数分かかります）");
}

// ==============================
// 投稿描画
// ==============================
function detectSiteName(url) {
  const u = (url || '').toLowerCase();
  if (u.includes('mgstage.com')) return 'MGS';
  if (u.includes('dmm.co.jp') || u.includes('fanza')) return 'FANZA';
  return '不明';
}

function renderPosts() {
  const postTable = document.querySelector('#postTable tbody');
  const allPostsTable = document.querySelector('#allPostsTable tbody');
  postTable.innerHTML = allPostsTable.innerHTML = "";

  posts.slice().reverse().forEach((p, i) => {
    const site = detectSiteName(p.url);
    const row = `
      <tr>
        <td><img src="${p.thumb}" alt="thumb"></td>
        <td><a href="${p.url}" target="_blank">${site}</a></td>
        <td><a href="${p.video}" target="_blank">動画</a></td>
        <td>${p.date || '—'}</td>
        <td>
          <button class="action-btn" onclick="editPost(${i})">編集</button>
          <button class="action-btn delete-btn" onclick="deletePost(${i})">削除</button>
        </td>
      </tr>`;
    postTable.insertAdjacentHTML('beforeend', row);
    allPostsTable.insertAdjacentHTML('beforeend', row);
  });
}

function editPost(i) {
  alert(`編集モード（仮）: ${posts[i].url}`);
}
</script>
</body>
</html>
